{% extends "base.html" %}

{% block title %}Chat - Fade{% endblock %}

{% block content %}
<div class="container" style="display: flex; gap: var(--spacing-lg); height: calc(100vh - 80px);">

    <!-- Sidebar -->
    <div class="card"
        style="width: 320px; display: flex; flex-direction: column; padding: var(--spacing-md); gap: var(--spacing-md);">

        <!-- Section: Friend Requests -->
        <div id="requests-section" style="display: none;">
            <h5 style="font-size: 0.9rem; color: var(--accent);">Friend Requests</h5>
            <div id="friend-requests-list" style="max-height: 150px; overflow-y: auto;"></div>
        </div>

        <!-- Section: Friends -->
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:center;">
                <h5 style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">Friends</h5>
                <!-- Search Icon / Toggle -->
                <button class="btn-icon" onclick="toggleFriendSearch()"
                    style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>

            <!-- Hidden Search Input -->
            <div id="friend-search-container" style="display:none; margin-bottom: 10px;">
                <input type="text" id="friend-search-input" class="form-control" placeholder="Search friends..."
                    onkeyup="filterFriends()" style="padding: 6px 12px; font-size: 0.9rem;">
            </div>

            <div class="friends-list" id="friends-list" style="flex: 1; overflow-y: auto;">
                <p style="color: var(--text-muted); font-size: 0.8rem; text-align: center;">Loading friends...</p>
            </div>
        </div>

        <!-- Section: Suggestions -->
        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: var(--spacing-sm);">

            <!-- Global Search -->
            <h5 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Find People</h5>
            <div style="display:flex; gap:5px; margin-bottom:12px;">
                <input type="text" id="global-search-input" class="form-control" placeholder="Username..."
                    style="padding: 6px 12px; font-size: 0.9rem;">
                <button class="btn btn-primary" onclick="searchGlobalUsers()" style="padding: 0 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>
            <div id="global-search-results" style="max-height: 100px; overflow-y: auto; margin-bottom: 10px;"></div>

            <h5 style="font-size: 0.9rem; color: var(--text-secondary); margin-top: var(--spacing-sm);">You May Like
            </h5>
            <div id="recommendations-list" style="max-height: 150px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="card" style="flex: 1; display: flex; flex-direction: column; padding: 0;">

        <!-- Header -->
        <div
            style="padding: var(--spacing-md); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between;">
            <div id="chat-header-info" style="display: none; align-items: center;">
                <span id="chat-status-dot" class="status-indicator"></span>
                <h4 style="margin: 0;" id="chat-username">Username</h4>
            </div>
            <div id="no-chat-header" style="color: var(--text-muted);">Select a friend to fade with</div>
        </div>

        <!-- Messages -->
        <div id="messages-container"
            style="flex: 1; overflow-y: auto; padding: var(--spacing-md); display: flex; flex-direction: column; gap: 8px;">
            <div style="text-align: center; color: var(--text-muted); margin-top: 2rem;">
                <i class="bi bi-chat-square-text" style="font-size: 2rem; opacity: 0.5;"></i>
                <p>Select a friend to start chatting</p>
            </div>
        </div>

        <!-- Input -->
        <div id="input-area"
            style="padding: var(--spacing-md); border-top: 1px solid rgba(255,255,255,0.05); display: none;">

            <!-- File Preview Area -->
            <div id="chat-file-preview"
                style="display: none; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px;">
                <div style="position: relative; display: inline-block;">
                    <img id="chat-preview-img" src=""
                        style="max-height: 80px; border-radius: var(--radius-sm); border: 1px solid var(--accent);">
                    <button onclick="clearChatFile()"
                        style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">&times;</button>
                </div>
            </div>

            <div style="display: flex; gap: var(--spacing-sm); align-items: flex-end;">
                <!-- Attach Button -->
                <button class="btn btn-secondary" onclick="document.getElementById('chat-file-input').click()"
                    style="height: 40px; width: 40px; display: flex; align-items: center; justify-content: center; padding: 0; border-radius: 50%;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                        </path>
                    </svg>
                </button>
                <input type="file" id="chat-file-input" accept="image/*" style="display: none;"
                    onchange="handleChatFileSelect(this)">

                <select id="expiration-select" class="form-control" style="width: auto; height: 40px;">
                    <option value="10s">10s</option>
                    <option value="1m">1m</option>
                    <option value="1h" selected>1h</option>
                </select>
                <input type="text" id="message-input" class="form-control" placeholder="Type a fading message..."
                    style="height: 40px;">
                <button class="btn btn-primary" id="send-button" style="height: 40px;">Send</button>
            </div>
        </div>

    </div>
</div>

<script>
    const socket = io({ withCredentials: true });
    const username = "{{ username }}";
    let currentRoom = null;
    let messageTimers = {};

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        loadSidebar();
        setInterval(loadSidebar, 30000); // Refresh sidebar every 30s
    });

    // --- Sidebar Data ---
    async function loadSidebar() {
        // Friends
        fetch('/api/friends/list')
            .then(r => r.json())
            .then(data => renderFriends(data.friends));

        // Requests
        fetch('/api/friends/requests')
            .then(r => r.json())
            .then(data => renderRequests(data.requests));

        // Recommendations
        fetch('/api/recommendations')
            .then(r => r.json())
            .then(data => renderRecommendations(data.users));
    }

    function renderFriends(friends) {
        const container = document.getElementById('friends-list');
        container.innerHTML = '';
        if (!friends || friends.length === 0) {
            container.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem;">No friends added.</p>';
            return;
        }

        // Helper for combining char strikethrough
        const toStrikethrough = (text) => text.split('').map(char => char + '\u0336').join('');

        friends.forEach(f => {
            const div = document.createElement('div');
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.style.borderRadius = 'var(--radius-sm)';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'space-between';
            div.className = 'nav-link';

            let displayName = f.username;
            let statusClass = f.online ? 'status-online' : 'status-offline';
            let extraStyle = '';

            if (f.expired) {
                // Apply User's Requested "Combining Character" Strikethrough
                displayName = toStrikethrough(displayName);
                statusClass = 'status-offline'; // Expired is offline
                extraStyle = 'opacity: 0.6;';
            }

            // Title for hover tooltip
            const hoverTitle = f.expired ? "This account is expired" : "";

            div.innerHTML = `
                <div style="display:flex; align-items:center; ${extraStyle}" title="${hoverTitle}">
                    <span class="status-indicator ${statusClass}"></span>
                    <span>${displayName}</span>
                </div>
            `;

            // Only allow chat if not expired? Or allow view?
            // User just said "expired for some time", implying maybe they come back?
            // "means this accound is justbexpired for some time"
            // For now, let's keep click active or maybe alert?
            // User request usually implies visual indication. Strikethrough often means "inactive".

            if (!f.expired) {
                div.onclick = () => startChat(f.username);
            } else {
                div.onclick = () => showToast("This account is currently expired.");
            }

            container.appendChild(div);
        });
    }

    function renderRequests(requests) {
        const container = document.getElementById('friend-requests-list');
        const section = document.getElementById('requests-section');
        container.innerHTML = '';

        if (!requests || requests.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        requests.forEach(req => {
            const div = document.createElement('div');
            div.style.padding = '6px';
            div.style.background = 'rgba(255,255,255,0.05)';
            div.style.marginBottom = '4px';
            div.style.borderRadius = 'var(--radius-sm)';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem;">${req}</span>
                    <button class="btn btn-primary" onclick="acceptRequest('${req}')" style="padding:2px 8px; font-size:0.7rem;">Accept</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function acceptRequest(reqUsername) {
        await fetch('/api/friends/accept', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: reqUsername })
        });
        loadSidebar();
    }

    function renderRecommendations(users) {
        const container = document.getElementById('recommendations-list');
        container.innerHTML = '';
        if (!users || users.length === 0) {
            container.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem; text-align:center;">No suggestions.</p>';
            return;
        }
        users.forEach(u => {
            const div = document.createElement('div');
            div.style.padding = '6px';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';
            div.innerHTML = `
                <span style="font-size:0.9rem; color:var(--text-secondary);">${u.username}</span>
                <button onclick="sendRequest('${u.username}')" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:1.2rem;">+</button>
            `;
            container.appendChild(div);
        });
    }

    async function sendRequest(target) {
        await fetch('/api/friends/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: target })
        });
        alert('Friend request sent to ' + target);
    }

    // --- Chat Logic ---
    function startChat(otherUser) {
        socket.emit('start_chat', { username: otherUser });
    }

    socket.on('chat_started', (data) => {
        currentRoom = data.room;

        // Update Header
        document.getElementById('no-chat-header').style.display = 'none';
        document.getElementById('chat-header-info').style.display = 'flex';
        document.getElementById('chat-username').innerText = data.other_user;
        document.getElementById('input-area').style.display = 'block';

        // Clear & Load Messages
        const container = document.getElementById('messages-container');
        container.innerHTML = '';

        if (data.messages) {
            data.messages.forEach(addMessage);
        }
    });

    socket.on('new_message', (data) => {
        if (currentRoom === data.room) {
            addMessage(data);
        }
    });

    function addMessage(msg) {
        const container = document.getElementById('messages-container');
        const isMe = msg.from === username;

        const div = document.createElement('div');
        div.className = 'message-bubble'; // We'll style inline for now but class implies styling
        div.id = `msg-${msg.id}`;

        // Inline styles for message bubbles
        div.style.maxWidth = '70%';
        div.style.padding = '10px 14px';
        div.style.borderRadius = 'var(--radius-md)';
        div.style.marginBottom = '8px';
        div.style.position = 'relative';
        div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
        div.style.background = isMe ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
        div.style.color = 'white';
        div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';

        div.innerHTML = `
            <div style="font-size:0.95rem;">${msg.message}</div>
            <div style="font-size:0.7rem; opacity:0.7; margin-top:4px; display:flex; justify-content:space-between; gap:8px;">
                <span>${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                <span id="timer-${msg.id}" style="font-weight:bold;">${formatTime(msg.time_remaining)}</span>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (msg.time_remaining > 0) {
            startTimer(msg.id, msg.time_remaining);
        }
    }

    function startTimer(id, seconds) {
        if (messageTimers[id]) clearInterval(messageTimers[id]);

        let remaining = seconds;
        const timerEl = document.getElementById(`timer-${id}`);
        const msgEl = document.getElementById(`msg-${id}`);

        messageTimers[id] = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(messageTimers[id]);
                if (timerEl) timerEl.innerText = 'Expired';
                if (msgEl) {
                    // Trigger fly-away animation
                    msgEl.style.animation = 'flyAway 1s forwards ease-in';
                    // After animation, hide or remove content
                    setTimeout(() => {
                        msgEl.innerHTML = '<span style="font-style:italic; opacity:0.5;">Message Expired</span>';
                        msgEl.style.animation = 'none'; // reset
                        msgEl.style.background = 'transparent';
                        msgEl.style.boxShadow = 'none';
                        msgEl.style.color = 'var(--text-muted)';
                        msgEl.style.padding = '0';
                        msgEl.style.textAlign = 'center';
                        msgEl.style.alignSelf = 'center';
                    }, 900);
                }
            } else {
                if (timerEl) timerEl.innerText = formatTime(remaining);
            }
        }, 1000);
    }

    function formatTime(sec) {
        if (!sec || sec < 0) return '0s';
        if (sec < 60) return sec + 's';
        return Math.floor(sec / 60) + 'm';
    }

    // --- Send ---
    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // --- File Handling ---
    let chatFile = null;

    function handleChatFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.size > 2 * 1024 * 1024) {
                alert("File too large (Max 2MB)");
                input.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                chatFile = {
                    data: e.target.result,
                    type: file.type
                };
                document.getElementById('chat-file-preview').style.display = 'block';
                document.getElementById('chat-preview-img').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function clearChatFile() {
        chatFile = null;
        document.getElementById('chat-file-input').value = '';
        document.getElementById('chat-file-preview').style.display = 'none';
        document.getElementById('chat-preview-img').src = '';
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        const expiry = document.getElementById('expiration-select').value;

        if (!text && !chatFile) return;
        if (!currentRoom) return;

        socket.emit('send_message', {
            room: currentRoom,
            message: text,
            expiration: expiry,
            file_data: chatFile ? chatFile.data : null,
            file_type: chatFile ? chatFile.type : null
        });

        input.value = '';
        clearChatFile();
    }

    // --- Render Update ---
    function addMessage(msg) {
        const container = document.getElementById('messages-container');
        const isMe = msg.from === username;

        const div = document.createElement('div');
        div.className = 'message-bubble';
        div.id = `msg-${msg.id}`;

        // Inline bubble style
        div.style.maxWidth = '70%';
        div.style.padding = '10px 14px';
        div.style.borderRadius = 'var(--radius-md)';
        div.style.marginBottom = '8px';
        div.style.position = 'relative';
        div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
        div.style.background = isMe ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
        div.style.color = 'white';
        div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';

        // Prepare Content
        let contentHtml = '';
        if (msg.message) {
            contentHtml += `<div style="font-size:0.95rem;">${msg.message}</div>`;
        }

        if (msg.file_data) {
            if (msg.file_type && msg.file_type.startsWith('image/')) {
                contentHtml += `<div style="margin-top:5px;"><img src="${msg.file_data}" style="max-width:100%; border-radius:4px; display:block;"></div>`;
            } else {
                contentHtml += `<div style="margin-top:5px;"><a href="${msg.file_data}" download class="btn" style="background:rgba(0,0,0,0.2); padding:4px 8px; font-size:0.8rem;">ðŸ“Ž Attachment</a></div>`;
            }
        }

        div.innerHTML = `
            ${contentHtml}
            <div style="font-size:0.7rem; opacity:0.7; margin-top:4px; display:flex; justify-content:space-between; gap:8px;">
                <span>${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                <span id="timer-${msg.id}" style="font-weight:bold;">${formatTime(msg.time_remaining)}</span>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (msg.time_remaining > 0) {
            startTimer(msg.id, msg.time_remaining);
        }
    }
    function toggleFriendSearch() {
        const container = document.getElementById('friend-search-container');
        const input = document.getElementById('friend-search-input');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            input.focus();
        } else {
            container.style.display = 'none';
            input.value = '';
            filterFriends(); // Reset list
        }
    }

    function filterFriends() {
        const query = document.getElementById('friend-search-input').value.toLowerCase();
        const listItems = document.querySelectorAll('#friends-list > div.nav-link');

        listItems.forEach(item => {
            const username = item.innerText.toLowerCase();
            if (username.includes(query)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    async function searchGlobalUsers() {
        const query = document.getElementById('global-search-input').value.trim();
        const container = document.getElementById('global-search-results');

        if (!query) return;

        container.innerHTML = '<small style="color:var(--text-muted)">Searching...</small>';

        try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            container.innerHTML = '';

            if (data.users.length === 0) {
                container.innerHTML = '<small style="color:var(--text-muted)">No users found.</small>';
                return;
            }

            data.users.forEach(u => {
                const div = document.createElement('div');
                div.style.padding = '4px 0';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';

                const action = u.is_friend
                    ? `<small style="color:var(--success)">Friend</small>`
                    : `<button onclick="sendRequest('${u.username}')" style="background:none; border:none; color:var(--accent); cursor:pointer;">+</button>`;

                div.innerHTML = `
                    <span style="font-size:0.9rem;">${u.username}</span>
                    ${action}
                `;
                container.appendChild(div);
            });

        } catch (e) {
            console.error(e);
            container.innerHTML = '<small style="color:var(--danger)">Error searching.</small>';
        }
    }
</script>
{% endblock %}