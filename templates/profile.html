{% extends "base.html" %}

{% block title %}Profile - {{ user.username }}{% endblock %}

{% block content %}
<div class="container" style="padding-top: var(--spacing-xl);">
    <div class="card" style="max-width: 600px; margin: 0 auto;">

        <!-- Profile Header -->
        <div style="text-align: center; margin-bottom: var(--spacing-lg);">
            <div
                style="width: 100px; height: 100px; background: rgba(145, 95, 240, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: var(--accent); font-size: 2.5rem; border: 2px solid var(--accent);">
                {{ user.username[0] | upper }}
            </div>
            <h2
                style="margin-top: var(--spacing-md); margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                {{ user.username }}
                <button class="btn-icon" onclick="showToast('Edit Profile coming soon!')" title="Edit Profile"
                    style="background:none; border:none; color:var(--accent); cursor:pointer; padding: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </h2>

            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span class="status-indicator {{ 'status-online' if stats.is_online else 'status-offline' }}"></span>
                <span style="color: var(--text-secondary);">{{ 'Online' if stats.is_online else 'Offline' }}</span>
            </div>
        </div>

        <!-- Info Grid -->
        <div
            style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: var(--radius-sm);">
                <small style="color: var(--text-muted); display: block;">Age</small>
                <span style="font-size: 1.1rem;">{{ user.age if user.age else 'N/A' }}</span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: var(--radius-sm);">
                <small style="color: var(--text-muted); display: block;">Total Friends</small>
                <span style="font-size: 1.1rem;">{{ user.total_friends }}</span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: var(--radius-sm);">
                <small style="color: var(--text-muted); display: block;">Account Duration</small>
                <span style="font-size: 1.1rem;">{{ user.account_duration if user.account_duration else 'Permanent'
                    }}</span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: var(--radius-sm);">
                <small style="color: var(--text-muted); display: block;">Joined</small>
                <span style="font-size: 1.1rem;">{{ user.created_at.strftime('%Y-%m-%d') }}</span>
            </div>
        </div>

        <!-- Interests -->
        <div style="margin-bottom: var(--spacing-lg);">
            <h4 style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">Interests</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                {% if user.interests %}
                {% for interest in user.interests.split(',') %}
                {% if interest.strip() %}
                <span
                    style="background: var(--accent); color: white; padding: 4px 12px; border-radius: var(--radius-pill); font-size: 0.9rem;">
                    {{ interest.strip() }}
                </span>
                {% endif %}
                {% endfor %}
                {% else %}
                <span style="color: var(--text-muted);">No interests added.</span>
                {% endif %}
            </div>
        </div>

        <!-- Friends Dropdown -->
        <div class="friend-dropdown" style="width: 100%;">
            <button class="btn" id="toggle-friends"
                style="width: 100%; justify-content: space-between; background: rgba(255,255,255,0.05); color: var(--text-secondary);">
                <span>View Friends</span>
                <span>â–¼</span>
            </button>
            <div class="friend-list" id="friend-list-container">
                <div style="padding: 8px; text-align: center; color: var(--text-muted);" id="friends-loading">Loading...
                </div>
                <ul id="friends-ul" style="max-height: 200px; overflow-y: auto;">
                    <!-- Populated via JS -->
                </ul>
            </div>
        </div>

    </div>
</div>

<script>
    const toggleBtn = document.getElementById('toggle-friends');
    const dropdown = document.querySelector('.friend-dropdown');
    const ul = document.getElementById('friends-ul');
    const loading = document.getElementById('friends-loading');
    let loaded = false;

    toggleBtn.addEventListener('click', async () => {
        dropdown.classList.toggle('active');

        if (dropdown.classList.contains('active') && !loaded) {
            try {
                const res = await fetch('/api/friends/list');
                const data = await res.json();

                loading.style.display = 'none';
                ul.innerHTML = '';

                if (data.friends && data.friends.length > 0) {
                    data.friends.forEach(f => {
                        const li = document.createElement('li');
                        li.style.padding = '8px';
                        li.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        li.style.display = 'flex';
                        li.style.alignItems = 'center';

                        const statusColor = f.online ? 'var(--success)' : 'var(--text-muted)';

                        li.innerHTML = `
                            <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; margin-right: 8px;"></span>
                            <span>${f.username}</span>
                        `;
                        ul.appendChild(li);
                    });
                } else {
                    ul.innerHTML = '<li style="padding:8px; color:var(--text-muted); text-align:center;">No friends yet.</li>';
                }
                loaded = true;
            } catch (err) {
                loading.innerText = 'Failed to load friends';
            }
        }
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });
</script>
{% endblock %}